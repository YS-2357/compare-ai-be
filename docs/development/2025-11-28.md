# 2025-11-28 개발 로그

- **계획**
  - UI 리브랜딩: Streamlit 제목을 “Compare-AI”로 변경, 레이아웃 정리(로그인/질문 분리).
  - 사용량 동기화: BE가 내려주는 `X-Usage-*` 헤더/summary로 UI 카운터 동기화.
  - FE 분리/배포 준비: `compare-ai-fe` 호출 계약 정리 후 배포 가능 상태 점검.
  - 인증 확장: 비밀번호 변경/회원탈퇴 라우트 추가(비번 찾기는 변경으로 대체).
- **진행 현황**
  - BE `/api/ask` 응답에 `X-Usage-Limit`/`X-Usage-Remaining` 헤더 및 summary 필드 추가, Upstash 오류 시 우회.
  - UI가 서버 헤더를 받아 사용량 카운터를 즉시 반영, 429 시 0으로 표시.
  - Streamlit 개선: 대화 로그 유지, 스트림 수신 순서 표시, source 표시. FASTAPI_URL 환경변수 우선 사용.
  - Rate limit: Upstash 장애 시에도 프로세스 메모리 캐시로 일일 3회 제한 유지.
  - Streamlit 로그아웃 시 `use_admin_bypass`/`admin_token`을 비워 우회 상태가 세션에 남아 일일 제한을 건너뛰는 이슈를 방지(기본값 없으면 False 보정).
- **다음 액션**
  1. Streamlit 제목/레이아웃 “Compare-AI”로 리브랜딩.
  2. README/.env.example에 `SUPABASE_JWKS_URL`(`.well-known/jwks.json`), `UPSTASH_*`, `DAILY_USAGE_LIMIT` 명시.
  3. FE 분리 작업 시작: `compare-ai-fe`에 로그인/질문 흐름 이식, BE 호출 계약 문서화.
  4. 인증 확장 라우트 추가(비밀번호 변경/회원탈퇴).
- **BE/FE 호출 계약 (초안)**
  - `/auth/register`: `POST` `{email, password}` → `200` `{id,email,confirmation_sent_at}`.
  - `/auth/login`: `POST` `{email, password}` → `200` `{access_token, token_type, refresh_token?, user}`.
  - `/api/ask`: `POST` `{question, turn?, max_turns?, history?}` (Authorization: Bearer <token>)  
    - 스트리밍 partial/summary, 헤더 `X-Usage-Limit`/`X-Usage-Remaining`(있을 때).
- **테스트/메모**
  - 우회 토글을 끈 상태로 `/api/ask` 호출 시 `X-Usage-Remaining`이 3→2→1로 줄어야 함. 계속 3이면 `x-admin-bypass` 헤더 잔류 또는 Upstash 미연결 가능성 점검.
  - Upstash 일일 3회 제한 정상 동작(4번째 이후 429 확인). 다만 재로그인 직후 UI 초기값이 항상 3으로 보이는 잔여 표시 버그가 있어, 서버 헤더/요약값으로 초기화하도록 추가 개선 필요.
