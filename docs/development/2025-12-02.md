# 2025-12-02 개발 로그

- **멀티턴 컨텍스트 시도 (미적용)**
  - GraphState를 `user_messages`, `model_messages`, `model_summaries`, `api_status` 중심으로 단순화하고 프롬프트를 `[대화 이력]` + `[현재 질문]`으로 구성, UI에서 모든 모델 응답을 history에 포함하도록 변경했으나 여전히 모델이 이전 응답을 참조하지 않음(멀티턴 실패 상태).
  - LLM 응답이 비었을 때 `raw_responses` 폴백 처리, 히스토리/요약 디버그 로그 추가, 미사용 헬퍼 정리.

- **멀티턴 컨텍스트 버그 원인/해결**
  - 원인: LangGraph가 `(role, content)` 튜플을 `HumanMessage`/`AIMessage`로 변환하는데, `_render_history_for_model`·`_maybe_summarize_history`가 `BaseMessage`를 문자열로 풀지 못해 `[대화 이력]` 섹션이 빈 상태로 전달되어 맥락이 사라짐.
  - 조치: `_message_to_text` 헬퍼를 추가해 `BaseMessage` 포함 모든 형태를 `role: content`로 직렬화하고, 히스토리 렌더/요약에서 이를 사용하도록 수정 → 프롬프트에 실제 히스토리가 반영되어 멀티턴 맥락 적용됨.
  - 결과: `_call_model_common`으로 모델 호출을 일원화, `_maybe_summarize_history`로 `MAX_CONTEXT_MESSAGES` 초과 시 모델별 요약/트리밍 처리, partial 이벤트에서도 모델별 마지막 assistant 발화를 answer로 노출해 UI가 일관된 스트림을 보여줌.

- **UI 멀티턴 전송**
  - 이전 턴의 모든 모델 응답을 `history`에 포함해 백엔드로 전달(모델 비교 목적 유지).
  - 스트림 파서를 `_parse_stream_events`로 분리해 partial/summary 이벤트를 누적하고, `_build_history_payload`로 chat_log → LangGraph history를 표준화. 질문 전송/세션 반영을 `_send_question`으로 정리.

- **정리**
  - 워크플로우 미사용 헬퍼 제거.
  - 미작성: 키 미설정 모델(Groq/Cohere/Mistral)은 계속 오류 이벤트 발생 중(정상).

- **다음 액션**
  1. 프롬프트를 더 강하게(“직전 질문 주제로 우선 해석”) 조정할지 검토.
  2. NODE_CONFIG 미사용 키 정리 여부 결정.
  3. 토큰 한도 기반 히스토리 트리밍/요약 정책 보완.
